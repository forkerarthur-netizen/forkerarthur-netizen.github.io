<!DOCTYPE html>
<html lang="de">
<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no" />
  <title>NPS Prognose Rechner</title>
  <link href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.2/dist/css/bootstrap.min.css" rel="stylesheet">

  <style>
    :root { --pad: clamp(12px, 3vw, 18px); }

    body {
      background: #f8f9fa;
      font-family: system-ui, sans-serif;
      padding: env(safe-area-inset-top) env(safe-area-inset-right) env(safe-area-inset-bottom) env(safe-area-inset-left);
    }

    .container {
      width: min(430px, 100%);
      max-width: 100vw;
      margin: 0 auto;
      padding: var(--pad);
      padding-top: max(1.2rem, env(safe-area-inset-top));
    }

    h2 { font-size: 1.5rem; margin-bottom: 1.2rem; }
    .form-label { font-size: 1.05rem; }

    .form-control, .form-select {
      font-size: 16px;
      min-height: 48px;
      padding: 0.7rem 0.8rem;
    }

    input, select, button { font-size: 16px; }

    .btn-primary {
      font-size: 16px;
      min-height: 52px;
      padding: 0.85rem 0;
      border-radius: 0.7rem;
      margin-top: 0.2rem;
    }

    .mb-3 { margin-bottom: 0.85rem !important; }

    .card {
      border-radius: 1.1rem;
      box-shadow: 0 2px 8px rgba(0,0,0,0.04);
    }

    .table-responsive { overflow-x: auto; }
    .table { font-size: 0.97em; }
    .table th, .table td { padding: 0.45rem 0.3rem; }

    .text-muted.small, .text-muted.small.mt-1 { font-size: 0.93em !important; }

    .kpi {
      font-size: 2rem;
      font-weight: 800;
      line-height: 1.1;
      margin-left: 0.5rem;
    }

    details summary {
      cursor: pointer;
      user-select: none;
      padding: 0.2em 0;
      margin-bottom: 0.5em;
    }

    @media (max-width: 600px) {
      .container { width: 100vw; max-width: 100vw; padding-left: var(--pad); padding-right: var(--pad); }
      h2 { font-size: 1.18rem; }
      .form-label { font-size: 0.98rem; }
      .form-control, .form-select { font-size: 16px; min-height: 48px; padding: 0.6rem 0.7rem; }
      .btn-primary {
        font-size: 16px;
        min-height: 52px;
        padding: 0.7rem 0;
        position: sticky;
        bottom: 10px;
        z-index: 10;
        box-shadow: 0 8px 24px rgba(0,0,0,.12);
      }
      .card { border-radius: 0.7rem; }
      .table { font-size: 0.93em; }
      body, .container { padding-bottom: 80px; }
    }


  </style>
  <style>
    /* Ensure the AdProvider slot is actually visible even before it fills */
    #ad-container { min-height: 220px; }
    ins.eas6a97888e33 { display: block; width: 100%; min-height: 220px; }
  </style>
</head>

<body>
  <div class="container">
    <h2 class="mb-4 text-center">NPS Prognose Rechner</h2>

    <div class="card p-3">
      <form id="npsForm">
        <div class="mb-3">
          <label for="totalSurveys" class="form-label">Gesamtbefragungen</label>
          <input type="number" class="form-control" id="totalSurveys" min="0" required>
        </div>

        <div class="mb-3">
          <label for="promoters" class="form-label">Promotoren</label>
          <input type="number" class="form-control" id="promoters" min="0" required>
        </div>

        <div class="mb-3">
          <label for="detractors" class="form-label">Detraktoren</label>
          <input type="number" class="form-control" id="detractors" min="0" required>
        </div>

        <div class="mb-3">
          <label for="workType" class="form-label">Arbeitszeitmodell</label>
          <select class="form-select" id="workType" required>
            <option value="8" selected>Vollzeit (8 h/Tag)</option>
            <option value="6.5">Teilzeit (6,5 h/Tag)</option>
            <option value="6">Teilzeit (6 h/Tag)</option>
          </select>
        </div>

        <div class="mb-3">
          <label for="productiveHours" class="form-label">Produktivstunden (bisher)</label>
          <input type="number" class="form-control" id="productiveHours" min="1" required>
        </div>

        <div class="mb-3">
          <label class="form-label">Restzeit-Eingabe</label>
          <select class="form-select" id="restType" onchange="toggleRestInput()">
            <option value="tage" selected>Verbleibende Arbeitstage</option>
            <option value="stunden">Verbleibende Produktivstunden</option>
          </select>
        </div>

        <div class="mb-3" id="daysLeftDiv">
          <label for="daysLeft" class="form-label">Verbleibende Arbeitstage</label>
          <input type="number" class="form-control" id="daysLeft" min="0" required>
        </div>

        <div class="mb-3" id="hoursLeftDiv" style="display:none;">
          <label for="hoursLeft" class="form-label">Verbleibende Produktivstunden</label>
          <input type="number" class="form-control" id="hoursLeft" min="0">
        </div>

        <div class="mb-3">
          <label for="targetNps" class="form-label">Ziel-NPS</label>
          <input type="number" class="form-control" id="targetNps" min="-100" max="100" required>
        </div>

        <!-- IMPORTANT: ad-trigger class -->
        <button type="submit" class="btn btn-primary w-100 ad-trigger">Berechnen</button>
      </form>
    </div>

    <!-- Ad Slot (In-Page / Provider-gesteuert) -->
    <div id="ad-container" class="mt-3"></div>

    <div id="results" class="mt-4" style="display:none;"></div>
  </div>

  <!-- AdProvider (pemsrv) – wird per JS geladen (damit wir Blocker erkennen können) -->

  <script>
    // ===== Validation helpers (from your original) =====
    document.getElementById("totalSurveys").addEventListener("blur", function() {
      const pro = parseInt(document.getElementById("promoters").value, 10) || 0;
      const det = parseInt(document.getElementById("detractors").value, 10) || 0;
      const gesInput = document.getElementById("totalSurveys");
      const minGes = pro + det;
      if ((parseInt(gesInput.value, 10) || 0) < minGes) {
        gesInput.value = minGes;
        gesInput.setCustomValidity("");
      }
    });

    function checkGesValid() {
      const ges = parseInt(document.getElementById("totalSurveys").value, 10) || 0;
      const pro = parseInt(document.getElementById("promoters").value, 10) || 0;
      const det = parseInt(document.getElementById("detractors").value, 10) || 0;
      const gesInput = document.getElementById("totalSurveys");

      if (ges < pro + det) {
        gesInput.setCustomValidity("Gesamtbefragungen darf nicht kleiner als Promotoren + Detraktoren sein.");
        gesInput.reportValidity();
        return false;
      } else {
        gesInput.setCustomValidity("");
        return true;
      }
    }

    function adjustGesIfNeeded() {
      const pro = parseInt(document.getElementById("promoters").value, 10) || 0;
      const det = parseInt(document.getElementById("detractors").value, 10) || 0;
      const gesInput = document.getElementById("totalSurveys");
      const ges = parseInt(gesInput.value, 10) || 0;
      const minGes = pro + det;
      if (ges < minGes) {
        gesInput.value = minGes;
        gesInput.setCustomValidity("");
      }
    }

    document.getElementById("totalSurveys").addEventListener("input", checkGesValid);
    document.getElementById("promoters").addEventListener("input", function() {
      adjustGesIfNeeded();
      checkGesValid();
    });
    document.getElementById("detractors").addEventListener("input", function() {
      adjustGesIfNeeded();
      checkGesValid();
    });

    function toggleRestInput() {
      const hverInput = document.getElementById('hoursLeft');
      const dverInput = document.getElementById('daysLeft');
      const hverDiv = document.getElementById('hoursLeftDiv');
      const dverDiv = document.getElementById('daysLeftDiv');
      const restType = document.getElementById('restType').value;

      if (restType === 'tage') {
        dverDiv.style.display = '';
        hverDiv.style.display = 'none';
        dverInput.required = true;
        hverInput.required = false;
      } else {
        dverDiv.style.display = 'none';
        hverDiv.style.display = '';
        dverInput.required = false;
        hverInput.required = true;
      }
    }

    // ===== NPS logic (from your original, unchanged) =====
    function generateScenarios(Pro, Det, Pas, zBef, zNPS, dver=0) {
      const scenarios = [];
      for (let fPro = 0; fPro <= zBef; fPro++) {
        for (let fDet = 0; fDet <= zBef - fPro; fDet++) {
          let fPas = zBef - fPro - fDet;
          if (fPas < 0) continue;

          const tPro = Pro + fPro;
          const tDet = Det + fDet;
          const tPas = Pas + fPas;
          const tGes = tPro + tDet + tPas;

          const tNPSraw = tGes > 0 ? ((tPro - tDet) / tGes) * 100 : 0;
          if (tNPSraw >= zNPS && tNPSraw < zNPS + 1) {
            scenarios.push({
              fPro, fPas, fDet,
              tPro, tPas, tDet,
              tNPS: Math.round(tNPSraw),
              tNPSraw,
              _zBef: zBef
            });
            if (scenarios.length >= 10) return scenarios;
          }
        }
      }
      return scenarios;
    }

    function npsColor(nps, target) {
      if (nps >= target) return '#198754';
      if (nps >= target - 10) return '#ffc107';
      return '#dc3545';
    }

    const form = document.getElementById('npsForm');
    const results = document.getElementById('results');

    function calculateNPS() {
      const Pro = parseInt(document.getElementById('promoters').value, 10);
      const Det = parseInt(document.getElementById('detractors').value, 10);
      const Ges = parseInt(document.getElementById('totalSurveys').value, 10);
      const Pas = Ges - Pro - Det;

      const hbis = parseFloat(document.getElementById('productiveHours').value);
      const ZeitMod = parseFloat(document.getElementById('workType').value);
      const d = hbis / ZeitMod;

      let dver;
      let hver;
      const restType = document.getElementById('restType').value;
      if (restType === 'tage') {
        dver = parseInt(document.getElementById('daysLeft').value, 10);
        hver = dver * ZeitMod;
      } else {
        hver = parseFloat(document.getElementById('hoursLeft').value);
        dver = hver / ZeitMod;
      }

      const zNPS = parseInt(document.getElementById('targetNps').value, 10);

      const tGes = Pro + Det + Pas;
      const tNPS = tGes > 0 ? Math.round(((Pro - Det) / tGes) * 100) : 0;

      const dBef = d > 0 ? (tGes / d) : 0;
      const zBef = Math.round(dBef * dver);

      const schwankung = 0.3;
      const minFuture = Math.max(0, Math.round(zBef * (1 - schwankung)));
      const maxFuture = Math.round(zBef * (1 + schwankung));

      results.innerHTML = `
        <div class="card p-3">
          <div class="d-flex justify-content-between align-items-center mb-2">
            <h5 class="mb-0">Ergebnisse</h5>
            <div class="kpi" style="color:${npsColor(tNPS, zNPS)}">${tNPS}</div>
          </div>
          <div><b>Durchschnittliche Befragungen/Tag:</b> ${dBef.toFixed(2)}</div>
          <div><b>Erwartete zukünftige Befragungen (±30%):</b> geschätzt: ${minFuture} bis ${maxFuture}</div>
          <div><b>Ziel-NPS:</b> ${zNPS}</div>
        </div>
      `;

      let filteredScenarios = [];
      for (let ef = minFuture; ef <= maxFuture; ef++) {
        const scenarios = generateScenarios(Pro, Det, Pas, ef, zNPS, dver);
        filteredScenarios = filteredScenarios.concat(scenarios);
      }

      let efExtra = maxFuture + 1;
      while (filteredScenarios.length < 10 && efExtra <= maxFuture + 20) {
        const scenarios = generateScenarios(Pro, Det, Pas, efExtra, zNPS, dver);
        filteredScenarios = filteredScenarios.concat(scenarios);
        efExtra++;
      }

      filteredScenarios = filteredScenarios.slice(0, 25);

      let scenarioTable = `<div class="card p-3">
        <h6 class="mb-2">Szenarien für Ziel-NPS</h6>
        <div class="table-responsive">
          <table class="table table-sm table-bordered align-middle text-center mb-0" style="font-size:0.95em;">
            <thead>
              <tr>
                <th>#</th>
                <th>Befr.</th>
                <th>+Pro<br><span style='font-weight:normal'>(/Tag)</span></th>
                <th>+Pas<br><span style='font-weight:normal'>(/Tag)</span></th>
                <th>+Det<br><span style='font-weight:normal'>(/Tag)</span></th>
                <th>NPS</th>
              </tr>
            </thead>
            <tbody>`;

      if (filteredScenarios.length === 0) {
        scenarioTable += `<tr>
          <td colspan="6" class="text-muted">
            Keine Szenarien gefunden, bei denen der Ziel-NPS exakt erreicht wird.<br>
            Bitte überprüfe die Eingaben oder wähle einen anderen Ziel-NPS.
          </td>
        </tr>`;
      } else {
        filteredScenarios.forEach((s, idx) => {
          let proPerDayVal = dver > 0 && typeof s.fPro === 'number' ? (s.fPro / dver).toFixed(2) : '-';
          let pasPerDayVal = dver > 0 && typeof s.fPas === 'number' ? (s.fPas / dver).toFixed(2) : '-';
          let detPerDayVal = dver > 0 && typeof s.fDet === 'number' ? (s.fDet / dver).toFixed(2) : '-';
          scenarioTable += `<tr>
            <td>${idx+1}</td>
            <td>${s._zBef}</td>
            <td>${s.fPro}<br><span style='font-size:0.85em;color:#888;'>(${proPerDayVal})</span></td>
            <td>${s.fPas}<br><span style='font-size:0.85em;color:#888;'>(${pasPerDayVal})</span></td>
            <td>${s.fDet}<br><span style='font-size:0.85em;color:#888;'>(${detPerDayVal})</span></td>
            <td style="color:${npsColor(s.tNPSraw, zNPS)}">${s.tNPSraw.toFixed(1)}</td>
          </tr>`;
        });
      }

      scenarioTable += `</tbody></table></div>
        <div class="text-muted small mt-1">Nur Szenarien, bei denen der Ziel-NPS exakt erreicht wird.</div>
      </div>`;

      results.innerHTML += `
        <details class="mt-3">
          <summary class="fw-semibold">Szenarien anzeigen</summary>
          ${scenarioTable}
        </details>
      `;

      results.style.display = 'block';
    }

    function ensureAdProviderScriptLoaded(done) {
      // Viele Ad-Netzwerke liefern nicht auf file:// aus (keine Origin/Referrer/Domain).
      if (window.location && window.location.protocol === 'file:') {
        window.__adProviderLoadReason = 'file-protocol';
        done(false);
        return;
      }

      var existing = document.getElementById('ad-provider-script');
      if (existing && existing.dataset.loaded === '1') {
        window.__adProviderLoadReason = 'already-loaded';
        done(true);
        return;
      }

      if (!existing) {
        var s = document.createElement('script');
        var timedOut = false;
        var t = setTimeout(function() {
          timedOut = true;
          window.__adProviderLoadReason = 'script-timeout';
          done(false);
        }, 5000);

        s.async = true;
        s.type = 'application/javascript';
        s.src = 'https://a.pemsrv.com/ad-provider.js';
        s.id = 'ad-provider-script';
        s.onload = function() {
          if (timedOut) return;
          clearTimeout(t);
          s.dataset.loaded = '1';
          window.__adProviderLoadReason = (typeof window.AdProvider !== 'undefined') ? 'loaded-ok' : 'loaded-no-global';
          done(!!window.AdProvider);
        };
        s.onerror = function() {
          if (timedOut) return;
          clearTimeout(t);
          window.__adProviderLoadReason = 'script-error';
          done(false);
        };
        document.head.appendChild(s);
        return;
      }

      // Script existiert, aber loaded-Flag fehlt (Race). Kurz warten.
      setTimeout(function() {
        window.__adProviderLoadReason = (typeof window.AdProvider !== 'undefined') ? 'race-ok' : 'race-no-global';
        done(!!window.AdProvider);
      }, 800);
    }

    function renderAdSlot() {
      var adContainer = document.getElementById('ad-container');
      if (!adContainer) return null;

      adContainer.innerHTML = '';

      var status = document.createElement('div');
      status.id = 'ad-status';
      status.className = 'text-muted small';
      status.textContent = 'Werbung wird geladen...';
      adContainer.appendChild(status);

      var adIns = document.createElement('ins');
      adIns.className = 'eas6a97888e33';
      adIns.setAttribute('data-zoneid', '5800584');
      adContainer.appendChild(adIns);
      return adIns;
    }

    function startAdThenShowResults() {
      var adIns = renderAdSlot();
      var adContainer = document.getElementById('ad-container');
      if (adContainer) {
        try { adContainer.scrollIntoView({ behavior: 'smooth', block: 'start' }); } catch (e) {}
      }

      var finished = false;
      var finish = function() {
        if (finished) return;
        finished = true;
        calculateNPS();
        try { results.scrollIntoView({ behavior: 'smooth', block: 'start' }); } catch (e) {}
      };

      // Beobachten: sobald der Provider etwas in <ins> einfügt, dann Ergebnisse.
      var observer;
      if (adIns && typeof MutationObserver !== 'undefined') {
        try {
          observer = new MutationObserver(function(mutations) {
            for (var i = 0; i < mutations.length; i++) {
              if (mutations[i].addedNodes && mutations[i].addedNodes.length) {
                if (observer) observer.disconnect();
                var st = document.getElementById('ad-status');
                if (st) st.remove();
                setTimeout(finish, 400);
                return;
              }
            }
          });
          observer.observe(adIns, { childList: true, subtree: true });
        } catch (e) {
          // ignore
        }
      }

      // Script laden (und Blocker erkennen), dann serve triggern
      ensureAdProviderScriptLoaded(function(loadedOk) {
        if (!loadedOk) {
          var st2 = document.getElementById('ad-status');
          var reason = window.__adProviderLoadReason || 'unknown';
          if (st2) {
            if (reason === 'file-protocol') {
              st2.textContent = 'Werbung kann nicht über file:// geladen werden. Bitte über http://localhost oder https:// öffnen.';
            } else if (reason === 'script-timeout') {
              st2.textContent = 'Werbung wird blockiert oder lädt zu lange (Timeout). Prüfe AdBlock/Tracking-Schutz.';
            } else {
              st2.textContent = 'Werbung konnte nicht geladen werden (Script blockiert/fehlerhaft).';
            }
          }
          return;
        }

        try {
          (window.AdProvider = window.AdProvider || []).push({"serve": {}});
        } catch (e) {
          // ignore
        }
      });

      // Fallback: nicht hängen bleiben
      setTimeout(function() {
        if (!finished) {
          var hasFill = !!(adIns && (adIns.childNodes && adIns.childNodes.length > 0));
          if (!hasFill) {
            var st3 = document.getElementById('ad-status');
            if (st3) st3.textContent = 'Werbung konnte nicht geladen werden (AdBlock/CSP/kein Fill).';
          }
        }
        finish();
      }, 6000);
    }

    // Klick auf Berechnen:
    // - Browser-Validierung sichtbar machen
    // - Ad/Ergebnisse laufen im submit-Handler (kein Reload)
    const submitBtn = form.querySelector('button[type="submit"]');
    if (submitBtn) {
      submitBtn.addEventListener('click', function() {
        // Browser-Validierung (required)
        form.reportValidity();
      });
    }

    // Fallback: Enter-Key Submit (falls jemand Enter drückt)
    form.addEventListener('submit', function(e) {
      e.preventDefault();
      if (!form.reportValidity()) return;
      if (!checkGesValid()) return;
      results.style.display = 'none';
      startAdThenShowResults();
    });
  </script>
</body>
</html>
<!DOCTYPE html>
<html lang="de">
<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no" />
  <title>NPS Prognose Rechner</title>
  <link href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.2/dist/css/bootstrap.min.css" rel="stylesheet">

  <style>
    :root { --pad: clamp(12px, 3vw, 18px); }

    body {
      background: #f8f9fa;
      font-family: system-ui, sans-serif;
      padding: env(safe-area-inset-top) env(safe-area-inset-right) env(safe-area-inset-bottom) env(safe-area-inset-left);
    }

    .container {
      width: min(430px, 100%);
      max-width: 100vw;
      margin: 0 auto;
      padding: var(--pad);
      padding-top: max(1.2rem, env(safe-area-inset-top));
    }

    h2 { font-size: 1.5rem; margin-bottom: 1.2rem; }
    .form-label { font-size: 1.05rem; }

    .form-control, .form-select {
      font-size: 16px;
      min-height: 48px;
      padding: 0.7rem 0.8rem;
    }

    input, select, button { font-size: 16px; }

    .btn-primary {
      font-size: 16px;
      min-height: 52px;
      padding: 0.85rem 0;
      border-radius: 0.7rem;
      margin-top: 0.2rem;
    }

    .mb-3 { margin-bottom: 0.85rem !important; }

    .card {
      border-radius: 1.1rem;
      box-shadow: 0 2px 8px rgba(0,0,0,0.04);
    }

    .table-responsive { overflow-x: auto; }
    .table { font-size: 0.97em; }
    .table th, .table td { padding: 0.45rem 0.3rem; }

    .text-muted.small, .text-muted.small.mt-1 { font-size: 0.93em !important; }

    .kpi {
      font-size: 2rem;
      font-weight: 800;
      line-height: 1.1;
      margin-left: 0.5rem;
    }

    details summary {
      cursor: pointer;
      user-select: none;
      padding: 0.2em 0;
      margin-bottom: 0.5em;
    }

    @media (max-width: 600px) {
      .container { width: 100vw; max-width: 100vw; padding-left: var(--pad); padding-right: var(--pad); }
      h2 { font-size: 1.18rem; }
      .form-label { font-size: 0.98rem; }
      .form-control, .form-select { font-size: 16px; min-height: 48px; padding: 0.6rem 0.7rem; }
      .btn-primary {
        font-size: 16px;
        min-height: 52px;
        padding: 0.7rem 0;
        position: sticky;
        bottom: 10px;
        z-index: 10;
        box-shadow: 0 8px 24px rgba(0,0,0,.12);
      }
      .card { border-radius: 0.7rem; }
      .table { font-size: 0.93em; }
      body, .container { padding-bottom: 80px; }
    }


  </style>
  <style>
    /* Ensure the AdProvider slot is actually visible even before it fills */
    #ad-container { min-height: 220px; }
    ins.eas6a97888e33 { display: block; width: 100%; min-height: 220px; }
  </style>
</head>

<body>
  <div class="container">
    <h2 class="mb-4 text-center">NPS Prognose Rechner</h2>

    <div class="card p-3">
      <form id="npsForm">
        <div class="mb-3">
          <label for="totalSurveys" class="form-label">Gesamtbefragungen</label>
          <input type="number" class="form-control" id="totalSurveys" min="0" required>
        </div>

        <div class="mb-3">
          <label for="promoters" class="form-label">Promotoren</label>
          <input type="number" class="form-control" id="promoters" min="0" required>
        </div>

        <div class="mb-3">
          <label for="detractors" class="form-label">Detraktoren</label>
          <input type="number" class="form-control" id="detractors" min="0" required>
        </div>

        <div class="mb-3">
          <label for="workType" class="form-label">Arbeitszeitmodell</label>
          <select class="form-select" id="workType" required>
            <option value="8" selected>Vollzeit (8 h/Tag)</option>
            <option value="6.5">Teilzeit (6,5 h/Tag)</option>
            <option value="6">Teilzeit (6 h/Tag)</option>
          </select>
        </div>

        <div class="mb-3">
          <label for="productiveHours" class="form-label">Produktivstunden (bisher)</label>
          <input type="number" class="form-control" id="productiveHours" min="1" required>
        </div>

        <div class="mb-3">
          <label class="form-label">Restzeit-Eingabe</label>
          <select class="form-select" id="restType" onchange="toggleRestInput()">
            <option value="tage" selected>Verbleibende Arbeitstage</option>
            <option value="stunden">Verbleibende Produktivstunden</option>
          </select>
        </div>

        <div class="mb-3" id="daysLeftDiv">
          <label for="daysLeft" class="form-label">Verbleibende Arbeitstage</label>
          <input type="number" class="form-control" id="daysLeft" min="0" required>
        </div>

        <div class="mb-3" id="hoursLeftDiv" style="display:none;">
          <label for="hoursLeft" class="form-label">Verbleibende Produktivstunden</label>
          <input type="number" class="form-control" id="hoursLeft" min="0">
        </div>

        <div class="mb-3">
          <label for="targetNps" class="form-label">Ziel-NPS</label>
          <input type="number" class="form-control" id="targetNps" min="-100" max="100" required>
        </div>

        <!-- IMPORTANT: ad-trigger class -->
        <button type="submit" class="btn btn-primary w-100 ad-trigger">Berechnen</button>
      </form>
    </div>

    <!-- Ad Slot (In-Page / Provider-gesteuert) -->
    <div id="ad-container" class="mt-3"></div>

    <div id="results" class="mt-4" style="display:none;"></div>
  </div>

  <!-- AdProvider (pemsrv) – wird per JS geladen (damit wir Blocker erkennen können) -->

  <script>
    // ===== Validation helpers (from your original) =====
    document.getElementById("totalSurveys").addEventListener("blur", function() {
      const pro = parseInt(document.getElementById("promoters").value, 10) || 0;
      const det = parseInt(document.getElementById("detractors").value, 10) || 0;
      const gesInput = document.getElementById("totalSurveys");
      const minGes = pro + det;
      if ((parseInt(gesInput.value, 10) || 0) < minGes) {
        gesInput.value = minGes;
        gesInput.setCustomValidity("");
      }
    });

    function checkGesValid() {
      const ges = parseInt(document.getElementById("totalSurveys").value, 10) || 0;
      const pro = parseInt(document.getElementById("promoters").value, 10) || 0;
      const det = parseInt(document.getElementById("detractors").value, 10) || 0;
      const gesInput = document.getElementById("totalSurveys");

      if (ges < pro + det) {
        gesInput.setCustomValidity("Gesamtbefragungen darf nicht kleiner als Promotoren + Detraktoren sein.");
        gesInput.reportValidity();
        return false;
      } else {
        gesInput.setCustomValidity("");
        return true;
      }
    }

    function adjustGesIfNeeded() {
      const pro = parseInt(document.getElementById("promoters").value, 10) || 0;
      const det = parseInt(document.getElementById("detractors").value, 10) || 0;
      const gesInput = document.getElementById("totalSurveys");
      const ges = parseInt(gesInput.value, 10) || 0;
      const minGes = pro + det;
      if (ges < minGes) {
        gesInput.value = minGes;
        gesInput.setCustomValidity("");
      }
    }

    document.getElementById("totalSurveys").addEventListener("input", checkGesValid);
    document.getElementById("promoters").addEventListener("input", function() {
      adjustGesIfNeeded();
      checkGesValid();
    });
    document.getElementById("detractors").addEventListener("input", function() {
      adjustGesIfNeeded();
      checkGesValid();
    });

    function toggleRestInput() {
      const hverInput = document.getElementById('hoursLeft');
      const dverInput = document.getElementById('daysLeft');
      const hverDiv = document.getElementById('hoursLeftDiv');
      const dverDiv = document.getElementById('daysLeftDiv');
      const restType = document.getElementById('restType').value;

      if (restType === 'tage') {
        dverDiv.style.display = '';
        hverDiv.style.display = 'none';
        dverInput.required = true;
        hverInput.required = false;
      } else {
        dverDiv.style.display = 'none';
        hverDiv.style.display = '';
        dverInput.required = false;
        hverInput.required = true;
      }
    }

    // ===== NPS logic (from your original, unchanged) =====
    function generateScenarios(Pro, Det, Pas, zBef, zNPS, dver=0) {
      const scenarios = [];
      for (let fPro = 0; fPro <= zBef; fPro++) {
        for (let fDet = 0; fDet <= zBef - fPro; fDet++) {
          let fPas = zBef - fPro - fDet;
          if (fPas < 0) continue;

          const tPro = Pro + fPro;
          const tDet = Det + fDet;
          const tPas = Pas + fPas;
          const tGes = tPro + tDet + tPas;

          const tNPSraw = tGes > 0 ? ((tPro - tDet) / tGes) * 100 : 0;
          if (tNPSraw >= zNPS && tNPSraw < zNPS + 1) {
            scenarios.push({
              fPro, fPas, fDet,
              tPro, tPas, tDet,
              tNPS: Math.round(tNPSraw),
              tNPSraw,
              _zBef: zBef
            });
            if (scenarios.length >= 10) return scenarios;
          }
        }
      }
      return scenarios;
    }

    function npsColor(nps, target) {
      if (nps >= target) return '#198754';
      if (nps >= target - 10) return '#ffc107';
      return '#dc3545';
    }

    const form = document.getElementById('npsForm');
    const results = document.getElementById('results');

    function calculateNPS() {
      const Pro = parseInt(document.getElementById('promoters').value, 10);
      const Det = parseInt(document.getElementById('detractors').value, 10);
      const Ges = parseInt(document.getElementById('totalSurveys').value, 10);
      const Pas = Ges - Pro - Det;

      const hbis = parseFloat(document.getElementById('productiveHours').value);
      const ZeitMod = parseFloat(document.getElementById('workType').value);
      const d = hbis / ZeitMod;

      let dver;
      let hver;
      const restType = document.getElementById('restType').value;
      if (restType === 'tage') {
        dver = parseInt(document.getElementById('daysLeft').value, 10);
        hver = dver * ZeitMod;
      } else {
        hver = parseFloat(document.getElementById('hoursLeft').value);
        dver = hver / ZeitMod;
      }

      const zNPS = parseInt(document.getElementById('targetNps').value, 10);

      const tGes = Pro + Det + Pas;
      const tNPS = tGes > 0 ? Math.round(((Pro - Det) / tGes) * 100) : 0;

      const dBef = d > 0 ? (tGes / d) : 0;
      const zBef = Math.round(dBef * dver);

      const schwankung = 0.3;
      const minFuture = Math.max(0, Math.round(zBef * (1 - schwankung)));
      const maxFuture = Math.round(zBef * (1 + schwankung));

      results.innerHTML = `
        <div class="card p-3">
          <div class="d-flex justify-content-between align-items-center mb-2">
            <h5 class="mb-0">Ergebnisse</h5>
            <div class="kpi" style="color:${npsColor(tNPS, zNPS)}">${tNPS}</div>
          </div>
          <div><b>Durchschnittliche Befragungen/Tag:</b> ${dBef.toFixed(2)}</div>
          <div><b>Erwartete zukünftige Befragungen (±30%):</b> geschätzt: ${minFuture} bis ${maxFuture}</div>
          <div><b>Ziel-NPS:</b> ${zNPS}</div>
        </div>
      `;

      let filteredScenarios = [];
      for (let ef = minFuture; ef <= maxFuture; ef++) {
        const scenarios = generateScenarios(Pro, Det, Pas, ef, zNPS, dver);
        filteredScenarios = filteredScenarios.concat(scenarios);
      }

      let efExtra = maxFuture + 1;
      while (filteredScenarios.length < 10 && efExtra <= maxFuture + 20) {
        const scenarios = generateScenarios(Pro, Det, Pas, efExtra, zNPS, dver);
        filteredScenarios = filteredScenarios.concat(scenarios);
        efExtra++;
      }

      filteredScenarios = filteredScenarios.slice(0, 25);

      let scenarioTable = `<div class="card p-3">
        <h6 class="mb-2">Szenarien für Ziel-NPS</h6>
        <div class="table-responsive">
          <table class="table table-sm table-bordered align-middle text-center mb-0" style="font-size:0.95em;">
            <thead>
              <tr>
                <th>#</th>
                <th>Befr.</th>
                <th>+Pro<br><span style='font-weight:normal'>(/Tag)</span></th>
                <th>+Pas<br><span style='font-weight:normal'>(/Tag)</span></th>
                <th>+Det<br><span style='font-weight:normal'>(/Tag)</span></th>
                <th>NPS</th>
              </tr>
            </thead>
            <tbody>`;

      if (filteredScenarios.length === 0) {
        scenarioTable += `<tr>
          <td colspan="6" class="text-muted">
            Keine Szenarien gefunden, bei denen der Ziel-NPS exakt erreicht wird.<br>
            Bitte überprüfe die Eingaben oder wähle einen anderen Ziel-NPS.
          </td>
        </tr>`;
      } else {
        filteredScenarios.forEach((s, idx) => {
          let proPerDayVal = dver > 0 && typeof s.fPro === 'number' ? (s.fPro / dver).toFixed(2) : '-';
          let pasPerDayVal = dver > 0 && typeof s.fPas === 'number' ? (s.fPas / dver).toFixed(2) : '-';
          let detPerDayVal = dver > 0 && typeof s.fDet === 'number' ? (s.fDet / dver).toFixed(2) : '-';
          scenarioTable += `<tr>
            <td>${idx+1}</td>
            <td>${s._zBef}</td>
            <td>${s.fPro}<br><span style='font-size:0.85em;color:#888;'>(${proPerDayVal})</span></td>
            <td>${s.fPas}<br><span style='font-size:0.85em;color:#888;'>(${pasPerDayVal})</span></td>
            <td>${s.fDet}<br><span style='font-size:0.85em;color:#888;'>(${detPerDayVal})</span></td>
            <td style="color:${npsColor(s.tNPSraw, zNPS)}">${s.tNPSraw.toFixed(1)}</td>
          </tr>`;
        });
      }

      scenarioTable += `</tbody></table></div>
        <div class="text-muted small mt-1">Nur Szenarien, bei denen der Ziel-NPS exakt erreicht wird.</div>
      </div>`;

      results.innerHTML += `
        <details class="mt-3">
          <summary class="fw-semibold">Szenarien anzeigen</summary>
          ${scenarioTable}
        </details>
      `;

      results.style.display = 'block';
    }

    function ensureAdProviderScriptLoaded(done) {
      // Viele Ad-Netzwerke liefern nicht auf file:// aus (keine Origin/Referrer/Domain).
      if (window.location && window.location.protocol === 'file:') {
        done(false);
        return;
      }

      var existing = document.getElementById('ad-provider-script');
      if (existing && existing.dataset.loaded === '1') {
        done(true);
        return;
      }

      if (!existing) {
        var s = document.createElement('script');
        s.async = true;
        s.type = 'application/javascript';
        s.src = 'https://a.pemsrv.com/ad-provider.js';
        s.id = 'ad-provider-script';
        s.onload = function() {
          s.dataset.loaded = '1';
          done(true);
        };
        s.onerror = function() {
          done(false);
        };
        document.head.appendChild(s);
        return;
      }

      // Script existiert, aber loaded-Flag fehlt (Race). Kurz warten.
      setTimeout(function() {
        done(!!window.AdProvider);
      }, 800);
    }

    function renderAdSlot() {
      var adContainer = document.getElementById('ad-container');
      if (!adContainer) return null;

      adContainer.innerHTML = '';

      var status = document.createElement('div');
      status.id = 'ad-status';
      status.className = 'text-muted small';
      status.textContent = 'Werbung wird geladen...';
      adContainer.appendChild(status);

      var adIns = document.createElement('ins');
      adIns.className = 'eas6a97888e33';
      adIns.setAttribute('data-zoneid', '5800584');
      adContainer.appendChild(adIns);
      return adIns;
    }

    function startAdThenShowResults() {
      var adIns = renderAdSlot();
      var adContainer = document.getElementById('ad-container');
      if (adContainer) {
        try { adContainer.scrollIntoView({ behavior: 'smooth', block: 'start' }); } catch (e) {}
      }

      var finished = false;
      var finish = function() {
        if (finished) return;
        finished = true;
        calculateNPS();
        try { results.scrollIntoView({ behavior: 'smooth', block: 'start' }); } catch (e) {}
      };

      // Beobachten: sobald der Provider etwas in <ins> einfügt, dann Ergebnisse.
      var observer;
      if (adIns && typeof MutationObserver !== 'undefined') {
        try {
          observer = new MutationObserver(function(mutations) {
            for (var i = 0; i < mutations.length; i++) {
              if (mutations[i].addedNodes && mutations[i].addedNodes.length) {
                if (observer) observer.disconnect();
                var st = document.getElementById('ad-status');
                if (st) st.remove();
                setTimeout(finish, 400);
                return;
              }
            }
          });
          observer.observe(adIns, { childList: true, subtree: true });
        } catch (e) {
          // ignore
        }
      }

      // Script laden (und Blocker erkennen), dann serve triggern
      ensureAdProviderScriptLoaded(function(loadedOk) {
        if (!loadedOk) {
          var st2 = document.getElementById('ad-status');
          if (st2) st2.textContent = 'Werbung konnte nicht geladen werden (Script blockiert?).';
          return;
        }

        try {
          (window.AdProvider = window.AdProvider || []).push({"serve": {}});
        } catch (e) {
          // ignore
        }
      });

      // Fallback: nicht hängen bleiben
      setTimeout(function() {
        if (!finished) {
          var hasFill = !!(adIns && (adIns.childNodes && adIns.childNodes.length > 0));
          if (!hasFill) {
            var st3 = document.getElementById('ad-status');
            if (st3) st3.textContent = 'Werbung konnte nicht geladen werden (AdBlock/CSP/kein Fill).';
          }
        }
        finish();
      }, 6000);
    }

    // Klick auf Berechnen:
    // - Browser-Validierung sichtbar machen
    // - Ad/Ergebnisse laufen im submit-Handler (kein Reload)
    const submitBtn = form.querySelector('button[type="submit"]');
    if (submitBtn) {
      submitBtn.addEventListener('click', function() {
        // Browser-Validierung (required)
        form.reportValidity();
      });
    }

    // Fallback: Enter-Key Submit (falls jemand Enter drückt)
    form.addEventListener('submit', function(e) {
      e.preventDefault();
      if (!form.reportValidity()) return;
      if (!checkGesValid()) return;
      results.style.display = 'none';
      startAdThenShowResults();
    });
  </script>
</body>
</html>

